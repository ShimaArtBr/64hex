<!DOCTYPE html>
<html lang="pt" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="64hex â€” Consultor do I Ching. 64 hexagramas em portuguÃªs, inglÃªs e chinÃªs clÃ¡ssico.">
<meta name="theme-color" content="#0d0806" id="metaTheme">
<title>64hex â€” I Ching</title>
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@300;400;500&family=Noto+Sans+SC:wght@400&family=Noto+Serif:ital,wght@0,400;0,700;1,400&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DESIGN TOKENS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  /* Dourado â€” mantido */
  --gold:      #c9a84c;
  --gold2:     #e8c97a;

  /* Laca vermelha â€” substitui o jade */
  --lacquer:   #8b1a1a;
  --lacquer2:  #c43030;

  /* Vermelho cinÃ¡brio â€” linhas mÃ³veis / alertas */
  --red:       #b52b0a;
  --red2:      #e03a1a;

  --bg-gold:   rgba(201,168,76,.13);
  --bg-lacquer: rgba(139,26,26,.18);
  --r:    8px;
  --r-lg: 12px;
  --transition-theme: background .25s, color .25s, border-color .25s;
}

/* DARK â€” negro quente, como o cÃ©u da foto */
[data-theme="dark"] {
  --bg:       #0d0806;
  --surface:  #150d08;
  --panel:    #1e1208;
  --panel2:   #261808;
  --text:     #ede8de;
  --muted:    #9a8878;
  --dim:      #7a6a5a;
  --input-bg: #261808;
  --input-bd: rgba(180,140,80,.2);
  --shadow:   rgba(0,0,0,.6);
  --ink:      var(--gold);
}

/* LIGHT â€” papel de arroz com tinta */
[data-theme="light"] {
  --bg:       #f5f0e8;
  --surface:  #fdfaf4;
  --panel:    #ffffff;
  --panel2:   #f0ebe0;
  --text:     #1a1008;
  --muted:    #6b5040;
  --dim:      #a09080;
  --input-bg: #faf7f0;
  --input-bd: rgba(120,80,40,.2);
  --shadow:   rgba(0,0,0,.1);
  --ink:      #7a4a10;
}

*,*::before,*::after { box-sizing: border-box; margin: 0; padding: 0; }

/* Focus visible global â€” acessibilidade WCAG 2.2 */
:focus-visible {
  outline: 2px solid var(--gold);
  outline-offset: 2px;
  border-radius: 3px;
}

html { font-size: 16px; scroll-behavior: smooth; }

body {
  font-family: 'Noto Sans', sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  line-height: 1.7;
  transition: var(--transition-theme);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOPBAR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.topbar {
  background: var(--surface);
  border-bottom: 1px solid var(--bg-gold);
  padding: 0 22px;
  height: 52px;
  position: sticky;
  top: 0;
  z-index: 100;
  box-shadow: 0 2px 14px var(--shadow);
  transition: var(--transition-theme);
}

.topbar-inner {
  max-width: 1080px;
  margin: 0 auto;
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.topbar-brand {
  display: flex;
  align-items: center;
  gap: 10px;
  text-decoration: none;
  flex-shrink: 0;
}

.brand-mark {
  width: 30px;
  height: 30px;
  border: 1.5px solid var(--gold);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1rem;
  color: var(--gold);
  font-family: 'Noto Serif', serif;
  flex-shrink: 0;
}

.brand-name {
  font-family: 'JetBrains Mono', monospace;
  font-size: .9rem;
  color: var(--gold);
  letter-spacing: .04em;
}

.brand-sub {
  font-size: .7rem;
  color: var(--muted);
  letter-spacing: .06em;
  font-family: 'Noto Sans', sans-serif;
}

.topbar-right { display: flex; align-items: center; gap: 9px; }

.topbar-badge {
  background: rgba(139,26,26,.15);
  border: 1px solid rgba(139,26,26,.4);
  border-radius: 20px;
  padding: 2px 9px;
  font-size: .72rem;
  color: var(--lacquer2);
  letter-spacing: .08em;
  font-family: 'JetBrains Mono', monospace;
}

/* â”€â”€ Lang dropdown â”€â”€ */
.lang-wrap { position: relative; }

.lang-btn {
  display: flex;
  align-items: center;
  gap: 5px;
  background: var(--panel);
  border: 1px solid var(--bg-gold);
  border-radius: var(--r);
  padding: 0 12px;
  height: 44px;
  cursor: pointer;
  color: var(--text);
  font-size: .82rem;
  font-family: 'Noto Sans', sans-serif;
  transition: border-color .2s;
}
.lang-btn:hover, .lang-btn:focus-visible { border-color: var(--gold); outline: none; }

.lang-arrow {
  font-size: .5rem;
  color: var(--muted);
  transition: transform .2s;
}
.lang-wrap.open .lang-arrow { transform: rotate(180deg); }

.lang-menu {
  display: none;
  position: absolute;
  top: calc(100% + 5px);
  right: 0;
  background: var(--panel);
  border: 1px solid var(--bg-gold);
  border-radius: var(--r);
  min-width: 145px;
  box-shadow: 0 8px 24px var(--shadow);
  z-index: 200;
  overflow: hidden;
}
.lang-wrap.open .lang-menu { display: block; }

.lang-opt {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 9px 12px;
  font-size: .82rem;
  color: var(--text);
  cursor: pointer;
  transition: background .15s;
  border: none;
  background: transparent;
  width: 100%;
  text-align: left;
  font-family: 'Noto Sans', sans-serif;
}
.lang-opt:hover { background: rgba(201,168,76,.1); color: var(--gold2); }
.lang-opt.active { color: var(--gold); }

/* â”€â”€ Theme button â”€â”€ */
.theme-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 44px;
  height: 44px;
  background: var(--panel);
  border: 1px solid var(--bg-gold);
  border-radius: var(--r);
  cursor: pointer;
  font-size: 1rem;
  transition: border-color .2s;
}
.theme-btn:hover { border-color: var(--gold); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LAYOUT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.page {
  max-width: 1080px;
  margin: 0 auto;
  padding: 28px 22px 80px;
  display: grid;
  grid-template-columns: 310px 1fr;
  gap: 24px;
  align-items: start;
}

@media (max-width: 780px) {
  .page { grid-template-columns: 1fr; padding: 16px 14px 56px; }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INPUT PANEL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.input-panel {
  background: var(--panel);
  border: 1px solid var(--bg-gold);
  border-radius: var(--r-lg);
  padding: 22px;
  position: sticky;
  top: 68px;
  box-shadow: 0 4px 18px var(--shadow);
  transition: var(--transition-theme);
}

.panel-title {
  font-family: 'Noto Serif', serif;
  font-size: 1rem;
  color: var(--gold);
  margin-bottom: 16px;
  padding-bottom: 10px;
  border-bottom: 1px solid transparent;
  border-image: linear-gradient(to right, rgba(201,168,76,.5), rgba(201,168,76,.08)) 1;
  display: flex;
  align-items: center;
  gap: 9px;
}
.panel-title-zh { font-size: 1.1rem; opacity: .65; }

.field-group { margin-bottom: 14px; }

.field-label {
  font-size: .72rem;
  color: var(--muted);
  letter-spacing: .09em;
  text-transform: uppercase;
  margin-bottom: 5px;
  display: block;
}

textarea {
  width: 100%;
  background: var(--input-bg);
  border: 1px solid var(--input-bd);
  border-radius: var(--r);
  color: var(--text);
  font-family: 'Noto Serif', serif;
  font-size: .86rem;
  padding: 9px 11px;
  outline: none;
  resize: none;
  transition: border-color .2s, background .25s, color .25s;
  line-height: 1.65;
}
textarea:focus { border-color: var(--gold); }
textarea::placeholder { color: var(--dim); font-style: italic; }

/* â”€â”€ Method tabs â”€â”€ */
.method-tabs {
  display: flex;
  gap: 6px;
  margin-bottom: 8px;
}
.method-tab {
  flex: 1;
  padding: 8px 6px;
  border: 1px solid var(--input-bd);
  border-radius: var(--r);
  background: var(--input-bg);
  color: var(--muted);
  font-size: .78rem;
  cursor: pointer;
  text-align: center;
  transition: all .2s;
  font-family: 'Noto Sans', sans-serif;
}
.method-tab:hover { border-color: var(--gold); color: var(--text); }
.method-tab.active {
  border-color: var(--gold);
  background: rgba(201,168,76,.1);
  color: var(--gold2);
}
.method-desc {
  font-size: .72rem;
  color: var(--dim);
  line-height: 1.6;
  min-height: 2rem;
}

/* â”€â”€ Consult button â”€â”€ */
.consult-btn {
  width: 100%;
  margin-top: 18px;
  padding: 14px;
  border-radius: var(--r);
  background: var(--gold);
  border: none;
  color: #1a1828;
  font-family: 'Noto Sans', sans-serif;
  font-size: .9rem;
  font-weight: 500;
  cursor: pointer;
  transition: background .2s, transform .1s, opacity .2s;
  letter-spacing: .03em;
  position: relative;
  overflow: hidden;
}
.consult-btn:hover:not(:disabled) { background: var(--gold2); }
.consult-btn:active:not(:disabled) { transform: scale(.98); }
.consult-btn:disabled { opacity: .55; cursor: not-allowed; }

/* â”€â”€ Coin stage â”€â”€ */
.coin-stage {
  margin-top: 14px;
  background: var(--panel2);
  border: 1px solid var(--bg-gold);
  border-radius: var(--r);
  padding: 10px 12px;
  display: none;
}
.coin-stage.visible { display: block; }

.coin-row {
  display: flex;
  justify-content: center;
  gap: 6px;
  margin: 3px 0;
}

.line-result-row {
  display: flex;
  align-items: center;
  gap: 7px;
  padding: 3px 0;
}

.line-num {
  color: var(--dim);
  font-family: 'JetBrains Mono', monospace;
  font-size: .72rem;
  width: 12px;
  text-align: right;
  flex-shrink: 0;
}

.coin {
  width: 22px;
  height: 22px;
  border-radius: 50%;
  border: 1.5px solid var(--gold);
  font-size: .72rem;
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--gold);
  font-family: 'JetBrains Mono', monospace;
  opacity: 0;
  transform: scale(.5) rotate(-90deg);
  transition: opacity .25s, transform .25s;
}
.coin.visible {
  opacity: 1;
  transform: scale(1) rotate(0deg);
}
.coin.heads { background: rgba(201,168,76,.18); }
.coin.tails { background: rgba(90,74,58,.15); color: var(--muted); border-color: var(--dim); }

.line-glyph {
  font-size: 1.6rem;
  line-height: 1;
  color: var(--gold);
  width: 26px;
  text-align: center;
  flex-shrink: 0;
  opacity: 0;
  transition: opacity .25s;
  letter-spacing: -1px;
}
.line-glyph.visible { opacity: 1; }
.line-glyph.moving  { color: var(--lacquer2); }

.line-sum {
  font-family: 'JetBrains Mono', monospace;
  color: var(--muted);
  font-size: .72rem;
  opacity: 0;
  transition: opacity .2s;
  flex-shrink: 0;
  width: 10px;
}
.line-sum.visible { opacity: 1; }
.line-sum.moving  { color: var(--lacquer2); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CORPUS LOADING STATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.corpus-loading {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: 340px;
  gap: 16px;
  opacity: .6;
}
.loading-sym {
  font-size: 2.5rem;
  color: var(--gold);
  animation: spinSlow 3s linear infinite;
}
@keyframes spinSlow {
  from { transform: rotate(0deg); }
  to   { transform: rotate(360deg); }
}
.loading-txt {
  font-size: .8rem;
  color: var(--muted);
  font-family: 'JetBrains Mono', monospace;
  letter-spacing: .06em;
}
.corpus-error {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: 200px;
  gap: 10px;
  color: var(--red2);
  font-size: .82rem;
  text-align: center;
  padding: 20px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   EMPTY STATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.empty-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: 380px;
  gap: 18px;
  opacity: .4;
  transition: opacity .3s;
}
.empty-sym {
  font-size: 5rem;
  line-height: 1;
  color: var(--gold);
  font-family: 'Noto Serif', serif;
}
.empty-txt {
  font-family: 'Noto Serif', serif;
  font-size: .88rem;
  color: var(--muted);
  text-align: center;
  line-height: 1.8;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HEX CARD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.hex-card {
  background: var(--panel);
  border: 1px solid var(--bg-gold);
  border-radius: var(--r-lg);
  padding: 26px 26px 22px;
  box-shadow: 0 4px 20px var(--shadow);
  transition: var(--transition-theme);
}

.hex-card-reveal {
  animation: fadeUp .45s ease both;
}
@keyframes fadeUp {
  from { opacity: 0; transform: translateY(14px); }
  to   { opacity: 1; transform: none; }
}

/* â”€â”€ Hex header â”€â”€ */
.hex-header {
  display: flex;
  align-items: flex-start;
  gap: 20px;
  margin-bottom: 20px;
  padding-bottom: 18px;
  border-bottom: 1px solid var(--bg-gold);
}

.hex-sym {
  font-size: 4rem;
  line-height: 1;
  color: var(--gold);
  font-family: 'Noto Serif', serif;
  flex-shrink: 0;
  /* Ritual reveal animation */
  opacity: 0;
  transform: scale(.7);
  transition: opacity .6s cubic-bezier(.22,1,.36,1), transform .6s cubic-bezier(.22,1,.36,1);
}
.hex-sym.revealed { opacity: 1; transform: scale(1); }

.hex-meta {}

.hex-num {
  font-size: .72rem;
  color: var(--muted);
  letter-spacing: .1em;
  text-transform: uppercase;
  font-family: 'JetBrains Mono', monospace;
}
.hex-name-zh {
  font-size: 1.5rem;
  color: var(--gold2);
  font-family: 'Noto Serif', serif;
  line-height: 1.2;
  margin-top: 2px;
}
.hex-name-py {
  font-size: .82rem;
  color: var(--muted);
  margin-top: 2px;
  font-style: italic;
}
.hex-name-tr {
  font-size: 1.1rem;
  color: var(--text);
  font-family: 'Noto Serif', serif;
  margin-top: 6px;
}
.hex-keywords {
  font-size: .72rem;
  color: var(--dim);
  margin-top: 6px;
  font-family: 'JetBrains Mono', monospace;
  letter-spacing: .04em;
}

@media (max-width: 780px) {
  .hex-header { flex-direction: column; gap: 10px; }
  .hex-sym { font-size: 3rem; }
}

/* â”€â”€ Trigrams row â”€â”€ */
.trigrams-row {
  display: flex;
  gap: 8px;
  margin-bottom: 16px;
  flex-wrap: wrap;
}
.trig-chip {
  display: flex;
  align-items: center;
  gap: 5px;
  background: rgba(201,168,76,.07);
  border: 1px solid rgba(201,168,76,.2);
  border-radius: 20px;
  padding: 3px 10px 3px 7px;
  font-size: .72rem;
}
.trig-pos { color: var(--dim); font-size: .7rem; font-family: 'JetBrains Mono', monospace; letter-spacing: .04em; }
.trig-sym { font-size: 1rem; color: var(--lacquer2); }
.trig-name { color: var(--muted); }
.trig-sep { color: var(--dim); font-size: .6rem; margin: 0 3px; }

/* â”€â”€ Moving lines alert â”€â”€ */
.moving-alert {
  background: rgba(196,48,48,.08);
  border: 1px solid rgba(196,48,48,.3);
  border-radius: var(--r);
  padding: 9px 13px;
  margin-bottom: 14px;
  font-size: .77rem;
  color: var(--lacquer2);
  display: flex;
  align-items: flex-start;
  gap: 9px;
  line-height: 1.5;
}
.moving-alert-icon { flex-shrink: 0; margin-top: 1px; }

/* â”€â”€ Question display â”€â”€ */
.question-display {
  font-family: 'Noto Serif', serif;
  font-style: italic;
  font-size: .85rem;
  color: var(--muted);
  border-left: 2px solid var(--gold);
  padding-left: 12px;
  margin-bottom: 16px;
  opacity: .8;
  line-height: 1.55;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ACCORDION SECTIONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.sections { margin-top: 2px; }

.section {
  border: 1px solid var(--bg-gold);
  border-radius: var(--r);
  margin-bottom: 7px;
  overflow: hidden;
  transition: border-color .2s;
}
.section:last-child { margin-bottom: 0; }

.section-hd {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 11px 15px;
  cursor: pointer;
  transition: background .15s;
  user-select: none;
  gap: 10px;
}
.section-hd:hover { background: rgba(201,168,76,.05); }

.section-hd-left { display: flex; align-items: center; gap: 9px; }

.section-zh {
  font-size: .95rem;
  color: var(--gold);
  font-family: 'Noto Serif', serif;
}
.section-lbl { font-size: .78rem; color: var(--muted); }

.section-arrow {
  font-size: .7rem;
  color: var(--dim);
  transition: transform .25s;
  flex-shrink: 0;
}
.section.open .section-arrow { transform: rotate(180deg); }

/* Smooth accordion com CSS Grid */
.section-body {
  display: grid;
  grid-template-rows: 0fr;
  overflow: hidden;
  transition: grid-template-rows .35s cubic-bezier(.4,0,.2,1), padding .35s cubic-bezier(.4,0,.2,1);
  padding: 0 15px;
}
.section-body > * {
  overflow: hidden;
}
.section.open .section-body {
  grid-template-rows: 1fr;
  padding: 0 15px 16px;
}

/* â”€â”€ Text blocks â”€â”€ */
.text-block { margin-bottom: 13px; }
.text-block:last-child { margin-bottom: 0; }

.text-lang {
  font-size: .7rem;
  color: var(--dim);
  letter-spacing: .1em;
  text-transform: uppercase;
  font-family: 'JetBrains Mono', monospace;
  margin-bottom: 4px;
}

.text-zh {
  font-family: 'Noto Serif', serif;
  font-size: .92rem;
  color: var(--ink);
  letter-spacing: .04em;
  line-height: 1.9;
  margin-bottom: 7px;
}

.text-verse {
  font-family: 'Noto Serif', serif;
  font-style: italic;
  font-size: .88rem;
  color: var(--text);
  line-height: 1.75;
  margin-bottom: 6px;
}

.text-commentary {
  font-size: .82rem;
  color: var(--muted);
  line-height: 1.8;
}

.text-en {
  font-size: .83rem;
  color: var(--text);
  line-height: 1.72;
  font-family: 'Noto Serif', serif;
}

.section-divider {
  height: 1px;
  background: var(--bg-gold);
  margin: 12px 0;
}

/* â”€â”€ Lines â”€â”€ */
.line-item { margin-bottom: 16px; }
.line-item:last-child { margin-bottom: 0; }

.line-header {
  font-size: .69rem;
  color: var(--gold);
  font-family: 'JetBrains Mono', monospace;
  letter-spacing: .06em;
  margin-bottom: 7px;
  display: flex;
  align-items: center;
  gap: 7px;
}
.line-header.is-moving { color: var(--lacquer2); }

.line-moving-tag {
  background: rgba(196,48,48,.14);
  border: 1px solid rgba(196,48,48,.35);
  color: var(--red2);
  border-radius: 10px;
  padding: 1px 6px;
  font-size: .72rem;
  letter-spacing: .05em;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MUTATED HEXAGRAM
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.hex2-wrapper {
  background: var(--panel);
  border: 1px solid rgba(139,26,26,.32);
  border-radius: var(--r-lg);
  padding: 22px 24px 18px;
  margin-top: 16px;
  box-shadow: 0 4px 18px var(--shadow);
  animation: fadeUp .45s ease .2s both;
  transition: var(--transition-theme);
}
.hex2-label {
  font-size: .72rem;
  color: var(--lacquer2);
  letter-spacing: .1em;
  text-transform: uppercase;
  font-family: 'JetBrains Mono', monospace;
  margin-bottom: 14px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INSTALL BANNER (PWA)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.install-banner {
  position: fixed;
  bottom: 16px;
  left: 50%;
  transform: translateX(-50%);
  background: var(--panel);
  border: 1px solid var(--bg-gold);
  border-radius: var(--r-lg);
  padding: 12px 18px;
  display: flex;
  align-items: center;
  gap: 12px;
  box-shadow: 0 8px 32px var(--shadow);
  z-index: 300;
  font-size: .8rem;
  color: var(--text);
  max-width: 340px;
  width: calc(100% - 32px);
  animation: slideUp .3s ease;
}
@keyframes slideUp {
  from { opacity: 0; transform: translateX(-50%) translateY(20px); }
  to   { opacity: 1; transform: translateX(-50%) translateY(0); }
}
.install-banner-text { flex: 1; line-height: 1.4; }
.install-banner-title { font-weight: 500; color: var(--gold); font-size: .82rem; }
.install-btn {
  background: var(--gold);
  border: none;
  border-radius: var(--r);
  padding: 7px 14px;
  color: #1a1828;
  font-size: .75rem;
  font-weight: 500;
  cursor: pointer;
  white-space: nowrap;
  font-family: 'Noto Sans', sans-serif;
}
.install-btn:hover { background: var(--gold2); }
.install-dismiss {
  background: none;
  border: none;
  color: var(--dim);
  cursor: pointer;
  font-size: 1.1rem;
  line-height: 1;
  padding: 2px;
}
.install-banner.hidden { display: none; }
</style>
</head>
<body>

<!-- TOP BAR -->
<header class="topbar">
  <div class="topbar-inner">
    <a class="topbar-brand" href="." aria-label="64hex â€” I Ching">
      <div class="brand-mark">æ˜“</div>
      <div>
        <div class="brand-name">64hex</div>
        <div class="brand-sub" data-i18n="brandSub">I Ching Â· å‘¨æ˜“</div>
      </div>
    </a>

    <div class="topbar-right">
      <span class="topbar-badge">ZHOU YI</span>

      <div class="lang-wrap" id="langWrap">
        <button class="lang-btn" id="langBtn"
                aria-haspopup="true" aria-expanded="false"
                aria-label="Selecionar idioma">
          <span id="langLabel">PT</span>
          <span class="lang-arrow" aria-hidden="true">â–¼</span>
        </button>
        <div class="lang-menu" id="langMenu" role="menu">
          <button class="lang-opt active" data-lang="pt" role="menuitem">ğŸ‡§ğŸ‡· PortuguÃªs</button>
          <button class="lang-opt" data-lang="en" role="menuitem">ğŸ‡¬ğŸ‡§ English</button>
          <button class="lang-opt" data-lang="zh" role="menuitem">ğŸ‡¨ğŸ‡³ ä¸­æ–‡</button>
        </div>
      </div>

      <button class="theme-btn" id="themeBtn" aria-label="Alternar tema" title="Alternar tema">
        â˜€ï¸
      </button>
    </div>
  </div>
</header>

<!-- PAGE -->
<main class="page">

  <!-- INPUT PANEL -->
  <aside class="input-panel" aria-label="Painel de consulta">
    <div class="panel-title">
      <span class="panel-title-zh" aria-hidden="true">å•</span>
      <span data-i18n="panelTitle">Consulta</span>
    </div>

    <div class="field-group">
      <label class="field-label" for="questionInput" data-i18n="questionLabel">
        Sua pergunta (opcional)
      </label>
      <textarea id="questionInput" rows="3"
        placeholder="Formule sua pergunta com clareza e intenÃ§Ã£oâ€¦"
        data-ph-pt="Formule sua pergunta com clareza e intenÃ§Ã£oâ€¦"
        data-ph-en="Formulate your question with clarity and intentionâ€¦"
        data-ph-zh="è¯·å¿ƒæ€€è¯šæ„ï¼Œæ¸…æ™°æé—®â€¦"
        aria-describedby="questionHint"></textarea>
      <div id="questionHint" class="sr-only">Campo opcional. A pergunta serÃ¡ exibida junto ao resultado.</div>
    </div>

    <div class="field-group">
      <label class="field-label" data-i18n="methodLabel">MÃ©todo</label>
      <div class="method-tabs">
        <button class="method-tab active" data-method="ritual" id="tabRitual">
          <span data-i18n="methodRitual">Ritual</span>
        </button>
        <button class="method-tab" data-method="direct" id="tabDirect">
          <span data-i18n="methodDirect">Direto</span>
        </button>
      </div>
      <div class="method-desc" id="methodDesc"></div>
    </div>

    <button class="consult-btn" id="consultBtn" data-i18n="consultBtn">
      Consultar o OrÃ¡culo
    </button>

    <div class="coin-stage" id="coinStage" aria-live="polite" aria-label="Resultado do lanÃ§amento das moedas"></div>
  </aside>

  <!-- RESULTS -->
  <section id="results" aria-live="polite" aria-label="Resultado da consulta">
    <div class="corpus-loading" id="loadingState">
      <div class="loading-sym" aria-hidden="true">â˜¯</div>
      <div class="loading-txt" data-i18n="loading">Carregando corpusâ€¦</div>
    </div>

    <div class="empty-state" id="emptyState" style="display:none">
      <div class="empty-sym" aria-hidden="true">ä·</div>
      <div class="empty-txt" data-i18n="emptyState">Formule uma intenÃ§Ã£o<br>e consulte o orÃ¡culo</div>
    </div>
  </section>

</main>

<!-- PWA Install Banner -->
<div class="install-banner hidden" id="installBanner" role="complementary" aria-label="Instalar aplicativo">
  <div class="install-banner-text">
    <div class="install-banner-title">Instalar 64hex</div>
    <div data-i18n="installMsg">Adicione Ã  tela inicial para uso offline</div>
  </div>
  <button class="install-btn" id="installBtn" data-i18n="installAction">Instalar</button>
  <button class="install-dismiss" id="installDismiss" aria-label="Fechar">âœ•</button>
</div>

<!-- Screen reader only -->
<style>.sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}</style>

<script>
'use strict';

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
var CORPUS = null;
var LANG = 'pt';
var METHOD = 'ritual';
var IS_CONSULTING = false;

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   i18n
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
var T = {
  pt: {
    brandSub: 'I Ching Â· å‘¨æ˜“',
    panelTitle: 'Consulta', questionLabel: 'Sua pergunta (opcional)',
    methodLabel: 'MÃ©todo',
    methodRitual: 'Ritual', methodDirect: 'Direto',
    methodRitualDesc: 'TrÃªs moedas lanÃ§adas seis vezes, uma linha por vez. Inclui linhas mÃ³veis e o hexagrama resultante.',
    methodDirectDesc: 'Um hexagrama sorteado diretamente, sem o ritual das moedas.',
    consultBtn: 'Consultar o OrÃ¡culo',
    loading: 'Carregando corpusâ€¦',
    loadError: 'Erro ao carregar o corpus. Verifique se corpus.json estÃ¡ na mesma pasta.',
    emptyState: 'Formule uma intenÃ§Ã£o\ne consulte o orÃ¡culo',
    secJudgment: 'O Julgamento', secImage: 'A Imagem', secLines: 'As Linhas',
    movingAlert: '<b>Linha(s) mÃ³vel(is): %l</b> â€” o hexagrama se transforma no hexagrama abaixo.',
    mutantLabel: 'Hexagrama resultante (apÃ³s as mutaÃ§Ãµes)',
    upperTrig: 'Superior', lowerTrig: 'Inferior',
    hexN: 'Hexagrama', noQuestion: '(sem pergunta registrada)',
    lineMoving: 'mÃ³vel',
    installMsg: 'Adicione Ã  tela inicial para uso offline',
    installAction: 'Instalar',
  },
  en: {
    brandSub: 'I Ching Â· å‘¨æ˜“',
    panelTitle: 'Consultation', questionLabel: 'Your question (optional)',
    methodLabel: 'Method',
    methodRitual: 'Ritual', methodDirect: 'Direct',
    methodRitualDesc: 'Three coins tossed six times, one line at a time. Includes moving lines and the resulting hexagram.',
    methodDirectDesc: 'A hexagram drawn directly, without the coin ritual.',
    consultBtn: 'Consult the Oracle',
    loading: 'Loading corpusâ€¦',
    loadError: 'Error loading corpus. Make sure corpus.json is in the same folder.',
    emptyState: 'Set your intention\nand consult the oracle',
    secJudgment: 'The Judgment', secImage: 'The Image', secLines: 'The Lines',
    movingAlert: '<b>Moving line(s): %l</b> â€” the hexagram transforms into the hexagram below.',
    mutantLabel: 'Resulting hexagram (mutations applied)',
    upperTrig: 'Upper', lowerTrig: 'Lower',
    hexN: 'Hexagram', noQuestion: '(no question recorded)',
    lineMoving: 'moving',
    installMsg: 'Add to home screen for offline use',
    installAction: 'Install',
  },
  zh: {
    brandSub: 'æ˜“ç¶“ Â· å‘¨æ˜“',
    panelTitle: 'å•å¦', questionLabel: 'æ‚¨çš„å•é¡Œï¼ˆé¸å¡«ï¼‰',
    methodLabel: 'æ–¹æ³•',
    methodRitual: 'å„€å¼', methodDirect: 'ç›´å–',
    methodRitualDesc: 'ä¸‰æšéŠ…éŒ¢æŠ•æ“²å…­æ¬¡ï¼Œé€çˆ»èµ·å¦ï¼Œå«å‹•çˆ»åŠè®Šå¦ã€‚',
    methodDirectDesc: 'ç›´æ¥å¾å…­åå››å¦ä¸­å–ä¸€å¦ï¼Œä¸ç¶“éŠ…éŒ¢å„€å¼ã€‚',
    consultBtn: 'å•å¦',
    loading: 'è¼‰å…¥ä¸­â€¦',
    loadError: 'èªæ–™åº«è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¢ºèª corpus.json æ˜¯å¦å­˜åœ¨ã€‚',
    emptyState: 'éœå¿ƒå‡ç¥ï¼Œå•å¦',
    secJudgment: 'å¦è¾­', secImage: 'è±¡å‚³', secLines: 'çˆ»è¾­',
    movingAlert: '<b>å‹•çˆ»ï¼šç¬¬ %l çˆ»</b> â€” æ­¤å¦å°‡è®Šç‚ºä¸‹æ–¹ä¹‹å¦ã€‚',
    mutantLabel: 'è®Šå¦ï¼ˆå‹•çˆ»å·²æ‡‰ï¼‰',
    upperTrig: 'ä¸Šå¦', lowerTrig: 'ä¸‹å¦',
    hexN: 'å¦', noQuestion: 'ï¼ˆæœªè¨˜å•é¡Œï¼‰',
    lineMoving: 'å‹•',
    installMsg: 'åŠ åˆ°ä¸»å±å¹•ä»¥ä¾›é›¢ç·šä½¿ç”¨',
    installAction: 'å®‰è£',
  }
};

function t(k) {
  var lang = T[LANG] || T.pt;
  return lang[k] !== undefined ? lang[k] : (T.pt[k] || k);
}

function updateMethodDesc() {
  var el = document.getElementById('methodDesc');
  if (el) el.textContent = METHOD === 'ritual' ? t('methodRitualDesc') : t('methodDirectDesc');
}

function applyLang(l) {
  LANG = l;
  document.documentElement.lang = l === 'zh' ? 'zh' : l === 'en' ? 'en' : 'pt-BR';

  document.querySelectorAll('[data-i18n]').forEach(function(el) {
    var k = el.getAttribute('data-i18n');
    var val = t(k);
    if (val !== k) el.innerHTML = val;
  });

  // Placeholder
  var qi = document.getElementById('questionInput');
  if (qi) qi.placeholder = qi.getAttribute('data-ph-' + l) || qi.getAttribute('data-ph-pt');

  // Lang label
  var labels = { pt: 'PT', en: 'EN', zh: 'ä¸­' };
  document.getElementById('langLabel').textContent = labels[l] || l.toUpperCase();

  // Active state
  document.querySelectorAll('.lang-opt').forEach(function(b) {
    b.classList.toggle('active', b.getAttribute('data-lang') === l);
  });

  // Re-render results if present
  if (CORPUS && document.querySelector('.hex-card')) {
    if (window._lastResult) renderResult(window._lastResult);
  }

  updateMethodDesc();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   THEME
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function applyTheme(theme) {
  document.documentElement.setAttribute('data-theme', theme);
  // Button shows the OTHER theme (what you'll switch to)
  document.getElementById('themeBtn').textContent = theme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
  document.getElementById('themeBtn').title = theme === 'dark' ? 'Modo claro' : 'Modo escuro';
  // Meta theme-color
  var metaTheme = document.getElementById('metaTheme');
  if (metaTheme) metaTheme.setAttribute('content', theme === 'dark' ? '#0d0806' : '#fdfaf4');
  try { localStorage.setItem('64hex-theme', theme); } catch(e) {}
}

document.getElementById('themeBtn').addEventListener('click', function() {
  var current = document.documentElement.getAttribute('data-theme');
  applyTheme(current === 'dark' ? 'light' : 'dark');
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CORPUS LOADING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function loadCorpus() {
  fetch('corpus.json')
    .then(function(r) {
      if (!r.ok) throw new Error('HTTP ' + r.status);
      return r.json();
    })
    .then(function(data) {
      CORPUS = data;
      document.getElementById('loadingState').style.display = 'none';
      document.getElementById('emptyState').style.display = 'flex';
      document.getElementById('consultBtn').disabled = false;
    })
    .catch(function(err) {
      var loading = document.getElementById('loadingState');
      loading.innerHTML =
        '<div class="corpus-error">' +
        '<div style="font-size:2rem">âš ï¸</div>' +
        '<div>' + escH(t('loadError')) + '</div>' +
        '<div style="font-size:.7rem;color:var(--dim);margin-top:6px">' + escH(String(err)) + '</div>' +
        '</div>';
    });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RANDOM â€” crypto.getRandomValues
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function secureRandInt(max) {
  var arr = new Uint32Array(1);
  crypto.getRandomValues(arr);
  return arr[0] % max;
}

function tossCoin() { return secureRandInt(2) === 0 ? 3 : 2; } // head=3, tail=2

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LINE LOGIC
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function lineValue(sum) {
  // sum: 6=yin moving, 7=yang fixed, 8=yin fixed, 9=yang moving
  if (sum === 6) return { yang: false, moving: true,  glyph: 'âš‹', sym: '6' };
  if (sum === 7) return { yang: true,  moving: false, glyph: 'âšŠ', sym: '7' };
  if (sum === 8) return { yang: false, moving: false, glyph: 'âš‹', sym: '8' };
  if (sum === 9) return { yang: true,  moving: true,  glyph: 'âšŠ', sym: '9' };
}

/* King Wen trigram index from 3 line booleans (bottom, mid, top) */
function trigramIndex(b0, b1, b2) {
  var key = (b2?1:0)*4 + (b1?1:0)*2 + (b0?1:0);
  var map = [8, 4, 6, 3, 7, 2, 5, 1]; // 000â†’å¤(8), 001â†’éœ‡(4), 010â†’å(6)â€¦
  return map[key];
}

function hexFromLines(lines) {
  // lines[0..2] = A,B,C = trigrama inferior (base)
  // lines[3..5] = D,E,F = trigrama superior (topo)
  var lower = trigramIndex(lines[0].yang, lines[1].yang, lines[2].yang);
  var upper = trigramIndex(lines[3].yang, lines[4].yang, lines[5].yang);
  return lookupHex(upper, lower);
}

function hexMutated(lines) {
  // Inverte linhas mÃ³veis e recalcula
  var mut = lines.map(function(l) {
    return { yang: l.moving ? !l.yang : l.yang };
  });
  var lower = trigramIndex(mut[0].yang, mut[1].yang, mut[2].yang);
  var upper = trigramIndex(mut[3].yang, mut[4].yang, mut[5].yang);
  return lookupHex(upper, lower);
}

function lookupHex(upper, lower) {
  return CORPUS.lookup[String(upper)][String(lower)];
}

function getHex(n) {
  return CORPUS.hexagrams.find(function(h) { return h.number === n; });
}

function getTrigram(n) {
  return CORPUS.trigrams[String(n)];
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   COIN ANIMATION â€” redesenhado do zero

   ROADMAP:
   1. SORTEIO (feito antes de chamar esta funÃ§Ã£o):
      lines[0]=A, lines[1]=B, lines[2]=C  â†’ trigrama inferior
      lines[3]=D, lines[4]=E, lines[5]=F  â†’ trigrama superior

   2. PRÃ‰-RENDERIZAÃ‡ÃƒO DO DOM (topoâ†’base):
      F(6), E(5), D(4), C(3), B(2), A(1)
      espelha visualmente o hexagrama ao lado

   3. ANIMAÃ‡ÃƒO (baseâ†’topo, ascendente):
      A(1) â†’ B(2) â†’ C(3) â†’ D(4) â†’ E(5) â†’ F(6)
      simula o ritual de construÃ§Ã£o da base ao topo

   4. DISPLAY ao usuÃ¡rio: A=1, B=2, C=3, D=4, E=5, F=6
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function animateCoins(lines, coins, onComplete) {
  var stage = document.getElementById('coinStage');
  stage.classList.add('visible');
  stage.innerHTML = '';

  var COIN_DELAY  = 80;
  var ROW_DELAY   = 240;
  var COIN_SETTLE = 300;

  // Letras internas â†’ Ã­ndice no array (A=base=idx0 ... F=topo=idx5)
  var LETTERS = ['A','B','C','D','E','F'];

  // Guarda referÃªncias DOM por letra para a animaÃ§Ã£o
  var rowRefs = {};

  // â”€â”€ PASSO 2: Renderiza DOM Fâ†’A (topoâ†’base) â”€â”€
  ['F','E','D','C','B','A'].forEach(function(letter) {
    var idx      = LETTERS.indexOf(letter); // Aâ†’0, Bâ†’1 ... Fâ†’5
    var lv       = lines[idx];
    var coinSet  = coins[idx];
    var isMoving = lv.moving;
    var display  = idx + 1; // nÃºmero exibido: Aâ†’1 ... Fâ†’6

    var row = document.createElement('div');
    row.className = 'line-result-row';

    // Glifo (âšŠ yang / âš‹ yin)
    var glyphEl = document.createElement('div');
    glyphEl.className = 'line-glyph' + (isMoving ? ' moving' : '');
    glyphEl.textContent = lv.yang ? 'âšŠ' : 'âš‹';
    row.appendChild(glyphEl);

    // NÃºmero da linha
    var numEl = document.createElement('div');
    numEl.className = 'line-num';
    numEl.textContent = display;
    row.appendChild(numEl);

    // Moedas
    var coinsWrap = document.createElement('div');
    coinsWrap.style.cssText = 'display:flex;gap:4px;flex:1;';
    coinSet.forEach(function(c) {
      var el = document.createElement('div');
      el.className = 'coin ' + (c === 3 ? 'heads' : 'tails');
      el.textContent = c === 3 ? 'â˜¯' : 'âœ¦';
      coinsWrap.appendChild(el);
    });
    row.appendChild(coinsWrap);

    // Soma
    var sumEl = document.createElement('div');
    sumEl.className = 'line-sum' + (isMoving ? ' moving' : '');
    sumEl.textContent = lv.sym;
    row.appendChild(sumEl);

    stage.appendChild(row);
    rowRefs[letter] = { coins: coinsWrap.children, glyph: glyphEl, sum: sumEl };
  });

  // â”€â”€ PASSO 3: Anima Aâ†’F (baseâ†’topo, ascendente) â”€â”€
  LETTERS.forEach(function(letter, animPos) {
    var base = animPos * ROW_DELAY;
    var r    = rowRefs[letter];
    Array.from(r.coins).forEach(function(coin, ci) {
      setTimeout(function() { coin.classList.add('visible'); }, base + ci * COIN_DELAY);
    });
    setTimeout(function() {
      r.glyph.classList.add('visible');
      r.sum.classList.add('visible');
    }, base + 3 * COIN_DELAY + COIN_SETTLE);
  });

  var total = 5 * ROW_DELAY + 3 * COIN_DELAY + COIN_SETTLE + 350;
  setTimeout(onComplete, total);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RENDER HELPERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function escH(s) {
  if (!s) return '';
  return String(s)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;');
}

function buildTextBlock(obj) {
  var html = '';
  var showPt = (LANG === 'pt');
  var showEn = (LANG === 'en');
  var showZh = true; // always show ZH

  // ZH
  if (showZh && obj.zh) {
    html += '<div class="text-block">';
    if (LANG !== 'zh') html += '<div class="text-lang">ZH â€” å¤æ–‡</div>';
    html += '<div class="text-zh">' + escH(obj.zh) + '</div>';
    html += '</div>';
  }

  // PT
  if (showPt && obj.pt_verse) {
    html += '<div class="text-block">';
    html += '<div class="text-verse">' + escH(obj.pt_verse) + '</div>';
    if (obj.pt_commentary) {
      html += '<div class="text-commentary">' + escH(obj.pt_commentary) + '</div>';
    }
    html += '</div>';
  }

  // EN
  if (showEn && obj.en) {
    html += '<div class="text-block">';
    html += '<div class="text-en">' + escH(obj.en) + '</div>';
    html += '</div>';
  }

  // ZH mode: also show EN as reference
  if (LANG === 'zh' && obj.en) {
    if (html && obj.zh) html += '<div class="section-divider"></div>';
    html += '<div class="text-block">';
    html += '<div class="text-lang">EN â€” Legge</div>';
    html += '<div class="text-en">' + escH(obj.en) + '</div>';
    html += '</div>';
  }

  return html;
}

function buildLinesBlock(lines, movingLines) {
  var html = '';
  movingLines = movingLines || [];

  lines.forEach(function(line, i) {
    var isMoving = movingLines.indexOf(i) >= 0;
    var headerPt = line.header_pt || ('Linha ' + line.position);
    var headerLabel = LANG === 'en'
      ? ('Line ' + line.position)
      : LANG === 'zh'
      ? ('ç¬¬' + line.position + 'çˆ»')
      : headerPt;

    html += '<div class="line-item">';
    html += '<div class="line-header' + (isMoving ? ' is-moving' : '') + '">';
    html += escH(headerLabel);
    if (isMoving) html += ' <span class="line-moving-tag">' + escH(t('lineMoving')) + '</span>';
    html += '</div>';

    // ZH
    if (line.zh) {
      html += '<div class="text-zh" style="font-size:.85rem;margin-bottom:5px">' + escH(line.zh) + '</div>';
    }

    // PT
    if (LANG === 'pt' && line.pt_verse) {
      html += '<div class="text-verse">' + escH(line.pt_verse) + '</div>';
      if (line.pt_commentary) {
        html += '<div class="text-commentary">' + escH(line.pt_commentary) + '</div>';
      }
    }

    // EN
    if (LANG === 'en' && line.en) {
      html += '<div class="text-en">' + escH(line.en) + '</div>';
    }

    // ZH mode: also show EN
    if (LANG === 'zh' && line.en) {
      html += '<div class="section-divider"></div>';
      html += '<div class="text-lang">EN â€” Legge</div>';
      html += '<div class="text-en">' + escH(line.en) + '</div>';
    }

    html += '</div>';
    if (i < lines.length - 1) html += '<div class="section-divider"></div>';
  });

  return html;
}

function buildSection(zhLabel, label, body, id, open) {
  return '<div class="section' + (open ? ' open' : '') + '" id="sec-' + id + '" data-section-id="' + id + '">' +
    '<div class="section-hd" role="button" tabindex="0" aria-expanded="' + (open ? 'true' : 'false') + '">' +
      '<div class="section-hd-left">' +
        '<span class="section-zh" aria-hidden="true">' + zhLabel + '</span>' +
        '<span class="section-lbl">' + escH(label) + '</span>' +
      '</div>' +
      '<span class="section-arrow" aria-hidden="true">â–¼</span>' +
    '</div>' +
    '<div class="section-body" role="region"><div>' + body + '</div></div>' +
  '</div>';
}

function buildTrigrams(hex) {
  var upper = getTrigram(hex.trigrams.u);
  var lower = getTrigram(hex.trigrams.l);
  if (!upper || !lower) return '';

  function trigName(trig) {
    if (LANG === 'zh') return trig.zh + ' ' + trig.pinyin;
    if (LANG === 'en') return trig.name_en;
    return trig.name_pt;
  }

  return '<div class="trigrams-row">' +
    '<div class="trig-chip">' +
      '<span class="trig-pos">' + escH(t('upperTrig')) + '</span>' +
      '<span class="trig-sep">Â·</span>' +
      '<span class="trig-sym">' + upper.symbol + '</span>' +
      '<span class="trig-name">' + escH(trigName(upper)) + '</span>' +
    '</div>' +
    '<div class="trig-chip">' +
      '<span class="trig-pos">' + escH(t('lowerTrig')) + '</span>' +
      '<span class="trig-sep">Â·</span>' +
      '<span class="trig-sym">' + lower.symbol + '</span>' +
      '<span class="trig-name">' + escH(trigName(lower)) + '</span>' +
    '</div>' +
  '</div>';
}

function buildHexHeader(hex) {
  var nameKey = LANG === 'zh' ? 'zh' : LANG === 'en' ? 'en' : 'pt';
  var hexName = hex.name[nameKey] || hex.name.en;
  return '<div class="hex-header">' +
    '<div class="hex-sym" id="hexSym-' + hex.number + '">' + hex.unicode + '</div>' +
    '<div class="hex-meta">' +
      '<div class="hex-num">' + escH(t('hexN')) + ' ' + hex.number + '</div>' +
      '<div class="hex-name-zh">' + escH(hex.name.zh) + '</div>' +
      '<div class="hex-name-py">' + escH(hex.name.pinyin) + '</div>' +
      '<div class="hex-name-tr">' + escH(hexName) + '</div>' +
      (hex.keywords ? '<div class="hex-keywords">' + escH(hex.keywords) + '</div>' : '') +
    '</div>' +
  '</div>';
}

function buildHexBody(hex, movingLines, isSecondary) {
  var q = isSecondary ? '' : (document.getElementById('questionInput').value || '').trim();
  var questionHtml = q ? '<div class="question-display">' + escH(q) + '</div>' : '';

  var trigHtml = buildTrigrams(hex);

  var movingHtml = '';
  if (movingLines && movingLines.length > 0) {
    var nums = movingLines.map(function(i) { return i + 1; }).join(', ');
    var msg = t('movingAlert').replace('%l', nums);
    movingHtml = '<div class="moving-alert"><span class="moving-alert-icon" aria-hidden="true">âŸ³</span><span>' + msg + '</span></div>';
  }

  // Only show lines section if primary (or if secondary with context)
  // For secondary hex: no moving lines, show judgment + image open, lines collapsed
  var linesToShow = isSecondary ? [] : movingLines;
  var showAllLines = isSecondary || (movingLines && movingLines.length === 0);

  // Lines: if there are moving lines, only show those lines; if none, show all
  var linesData = showAllLines
    ? hex.lines
    : hex.lines.filter(function(_, i) { return linesToShow.indexOf(i) >= 0; });

  var sections =
    buildSection('å¦è¾­', t('secJudgment'), buildTextBlock(hex.judgment), 'judgment-' + hex.number, true) +
    buildSection('è±¡å‚³', t('secImage'),    buildTextBlock(hex.image),    'image-' + hex.number,    false) +
    buildSection('çˆ»è¾­', t('secLines'),    buildLinesBlock(linesData, movingLines), 'lines-' + hex.number, !isSecondary);

  return questionHtml + trigHtml + movingHtml + '<div class="sections">' + sections + '</div>';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RENDER RESULT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderResult(result) {
  var hex    = result.hex;
  var mutHex = result.mutHex;
  var movingLines = result.movingLines;

  // Hide empty state
  var emptyState = document.getElementById('emptyState');
  if (emptyState) emptyState.style.display = 'none';

  var html =
    '<div class="hex-card hex-card-reveal">' +
      buildHexHeader(hex) +
      buildHexBody(hex, movingLines, false) +
    '</div>';

  if (mutHex) {
    html +=
      '<div class="hex2-wrapper">' +
        '<div class="hex2-label">' + escH(t('mutantLabel')) + '</div>' +
        buildHexHeader(mutHex) +
        buildHexBody(mutHex, [], true) +
      '</div>';
  }

  document.getElementById('results').innerHTML = html;

  // Ritual: reveal hexagram symbol with delay
  setTimeout(function() {
    var sym = document.getElementById('hexSym-' + hex.number);
    if (sym) sym.classList.add('revealed');
  }, 80);
  if (mutHex) {
    setTimeout(function() {
      var sym2 = document.getElementById('hexSym-' + mutHex.number);
      if (sym2) sym2.classList.add('revealed');
    }, 350);
  }

  // Scroll to results on mobile
  if (window.innerWidth <= 780) {
    setTimeout(function() {
      document.getElementById('results').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }, 100);
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONSULTATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
document.getElementById('consultBtn').addEventListener('click', function() {
  if (!CORPUS || IS_CONSULTING) return;
  IS_CONSULTING = true;

  var btn = document.getElementById('consultBtn');
  btn.disabled = true;
  btn.textContent = 'â€¦';

  // Clear previous result
  var resultsEl = document.getElementById('results');
  var emptyState = document.getElementById('emptyState');
  if (emptyState) emptyState.style.display = 'none';

  // Reset coin stage
  var coinStage = document.getElementById('coinStage');
  coinStage.classList.remove('visible');
  coinStage.innerHTML = '';

  // Generate result based on method
  if (METHOD === 'ritual') {

    /* â”€â”€ PASSO 1: SORTEIO Aâ†’F â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       lines[0]=A=linha1(base) ... lines[5]=F=linha6(topo)
       coins[i] = [c1,c2,c3] das moedas da linha i
       Trigrama inferior: lines[0..2] = A,B,C
       Trigrama superior: lines[3..5] = D,E,F
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    var lines = [];
    var coins = [];
    for (var i = 0; i < 6; i++) {
      var c1 = tossCoin(), c2 = tossCoin(), c3 = tossCoin();
      coins.push([c1, c2, c3]);
      lines.push(lineValue(c1 + c2 + c3));
    }

    /* â”€â”€ PASSO 4: RESULTADO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       movingLines: Ã­ndices 0â€“5 das linhas mÃ³veis
       hexFromLines usa lines[0..2] como inferior
                        lines[3..5] como superior
       hexMutated inverte as linhas mÃ³veis e recalcula
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    var movingLines = [];
    lines.forEach(function(l, i) { if (l.moving) movingLines.push(i); });

    var hexNum    = hexFromLines(lines);
    var mutHexNum = movingLines.length > 0 ? hexMutated(lines) : null;
    var hex       = getHex(hexNum);
    var mutHex    = mutHexNum ? getHex(mutHexNum) : null;

    var result = { hex: hex, mutHex: mutHex, movingLines: movingLines };
    window._lastResult = result;

    /* â”€â”€ PASSOS 2+3: ANIMAÃ‡ÃƒO â†’ depois RENDERIZA â”€â”€â”€â”€â”€ */
    animateCoins(lines, coins, function() {
      renderResult(result);
      btn.disabled = false;
      btn.innerHTML = t('consultBtn');
      IS_CONSULTING = false;
    });

  } else {
    // Direct: pick random hexagram, no coins, no moving lines
    var hexNum = secureRandInt(64) + 1;
    var hex = getHex(hexNum);
    var result = { hex: hex, mutHex: null, movingLines: [] };
    window._lastResult = result;

    renderResult(result);
    btn.disabled = false;
    btn.innerHTML = t('consultBtn');
    IS_CONSULTING = false;
  }
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ACCORDION â€” event delegation (no inline onclick)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
document.getElementById('results').addEventListener('click', function(e) {
  var hd = e.target.closest('.section-hd');
  if (!hd) return;
  var section = hd.closest('.section');
  if (!section) return;
  var isOpen = section.classList.toggle('open');
  hd.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
});

document.getElementById('results').addEventListener('keydown', function(e) {
  if (e.key === 'Enter' || e.key === ' ') {
    var hd = e.target.closest('.section-hd');
    if (hd) { e.preventDefault(); hd.click(); }
  }
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   METHOD TABS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
document.querySelectorAll('.method-tab').forEach(function(tab) {
  tab.addEventListener('click', function() {
    METHOD = this.getAttribute('data-method');
    document.querySelectorAll('.method-tab').forEach(function(t) { t.classList.remove('active'); });
    this.classList.add('active');
    updateMethodDesc();
    // Reset coin stage when switching
    var coinStage = document.getElementById('coinStage');
    coinStage.classList.remove('visible');
    coinStage.innerHTML = '';
  });
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LANG DROPDOWN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
document.getElementById('langBtn').addEventListener('click', function(e) {
  e.stopPropagation();
  var wrap = document.getElementById('langWrap');
  var isOpen = wrap.classList.toggle('open');
  this.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
});

document.addEventListener('click', function() {
  var wrap = document.getElementById('langWrap');
  if (wrap.classList.contains('open')) {
    wrap.classList.remove('open');
    document.getElementById('langBtn').setAttribute('aria-expanded', 'false');
  }
});

document.getElementById('langMenu').addEventListener('click', function(e) {
  e.stopPropagation();
  var opt = e.target.closest('.lang-opt');
  if (!opt) return;
  applyLang(opt.getAttribute('data-lang'));
  document.getElementById('langWrap').classList.remove('open');
  document.getElementById('langBtn').setAttribute('aria-expanded', 'false');
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PWA â€” Service Worker + Install Banner
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function() {
    navigator.serviceWorker.register('sw.js').catch(function(err) {
      console.warn('SW registration failed:', err);
    });
  });
}

var deferredInstall = null;

window.addEventListener('beforeinstallprompt', function(e) {
  e.preventDefault();
  deferredInstall = e;
  // Show banner after a small delay
  setTimeout(function() {
    var banner = document.getElementById('installBanner');
    if (banner) banner.classList.remove('hidden');
  }, 3000);
});

document.getElementById('installBtn').addEventListener('click', function() {
  if (!deferredInstall) return;
  deferredInstall.prompt();
  deferredInstall.userChoice.then(function() {
    deferredInstall = null;
    document.getElementById('installBanner').classList.add('hidden');
  });
});

document.getElementById('installDismiss').addEventListener('click', function() {
  document.getElementById('installBanner').classList.add('hidden');
  try { localStorage.setItem('64hex-install-dismissed', '1'); } catch(e) {}
});

window.addEventListener('appinstalled', function() {
  document.getElementById('installBanner').classList.add('hidden');
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INIT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
window.addEventListener('DOMContentLoaded', function() {
  // Restore saved theme
  var savedTheme = null;
  try { savedTheme = localStorage.getItem('64hex-theme'); } catch(e) {}
  applyTheme(savedTheme === 'light' ? 'light' : 'dark');

  // Restore saved lang
  var savedLang = null;
  try { savedLang = localStorage.getItem('64hex-lang'); } catch(e) {}
  applyLang(savedLang || 'pt');

  // Disable consult btn until corpus loads
  document.getElementById('consultBtn').disabled = true;

  // Show initial method description
  updateMethodDesc();

  // Load corpus
  loadCorpus();
});

// Save lang preference on change
var _origApplyLang = applyLang;
applyLang = function(l) {
  _origApplyLang(l);
  try { localStorage.setItem('64hex-lang', l); } catch(e) {}
};
</script>
</body>
</html>
